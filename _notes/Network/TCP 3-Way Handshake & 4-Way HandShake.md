---
title: TCP 3-Way Handshake & 4-Way HandShake
category: Network
layout: note
---
TCP는 인터넷 프로토콜 스택의 핵심 프로토콜 중 하나로, 신뢰성 있는 연결 지향형 프로토콜이다. 데이터를 순서대로, 오류 없이, 중복 없이 전송하는 것을 보장한다. TCP는 연결을 설정하고(3-way handshake), 데이터를 전송하고, 연결을 종료하는(4-way handshake) 과정을 거칩니다. 
1. 3-Way Handshake (연결 설정): 
	TCP 연결을 설정하는 과정으로, 클라이언트와 서버가 서로 통신할 준비가 되었는지 확인하는 절차이다. 
	- 1단계 (SYN):
		클라이언트가 서버에게 연결 요청을 보낸다. SYN 패킷 전송
		SYN 패킷에는 클라이언트가 사용할 초기 시퀀스 번호(Sequence Number, ISN)가 포함된다. 
		클라이언트는 SYN_SENT 상태가 된다. 
	- 2단계 (SYN + ACK):
		서버가 클라이언트의 연결 요청을 수락한다. SYN +ACK 패킷 전송
		SYN+ACK 패킷에는 서버가 사용할 초기 시퀀스 번호(ISN)와 클라이언트 SYN에 대한 응답으로 ACK번호(클라이언트 ISN + 1)가 포함된다. 
		서버는 SYN_RECEIVED 상태가 된다.
	- 3단계 (ACK)
		클라이언트가 서버의 응답을 확인하고 연결을 확립한다. (ACK 패킷 전송)
		ACK 패킷에는 서버의 SYN에 대한 응답으로 ACK 번호(서버 ISN + 1)가 포함된다. 
		클라이언트와 서버는 모두 ESTABLISHED 상태가 되며, 데이터 전송을 시작할 수 있다. 
		![[Pasted image 20250324171224.png]]
2. 4-Way Hand Shake (연결 종료)
	TCP 연결을 종료하는 과정으로, 클라이언트와 서버가 서로에게 더 이상 전송할 데이터가 없음을 확인하는 절차이다.
	- 1단계 (FIN):
		클라이언트가 서버에게 연결 종료 요청을 보낸다. FIN 패킷 전송
		클라이언트는 FIN_WAIT_1 상태가 된다.
	- 2단계 (ACK):
		서버가 클라이언트의 연결 종료 요청을 한다. ACK 패킷 전송
		서버는 CLOSE_WAIT 상태가 된다.
		클라이언트는 FIN_WAIT_2 상태가 된다. 
	- 3단계 (FIN):
		서버도 클라이언트에게 연결 종료를 요청한다. FIN 패킷 전송
		서버는 LAST_ACK 상태가 된다. 
	- 4단계 (ACK):
		클라이언트가 서버의 연결 종료 요청을 확인하고 응답한다. ACK 패킷 전송
		클라이언트는 TIME_WAIT 상태가 된다. (일정 시간 동안 소켓을 유지)
		서버는 CLOSED 상태가 된다. 
		
	![[Pasted image 20250324172128.png]]

TIME_WAIT 상태는 클라이언트가 마지막 ACK를 보낸 후 일정 시간 동안 유지되는 상태이다. 이 상태의 목적은 다음과 같다. 
- 지연된 패킷 처리: 네트워크 상에서 지연된 패킷이 도착했을 때, 이전 연결의 패킷으로 잘못 처리되는 것을 방지
- 서버의 정상 종료 보장: 클라이언트가 보낸 마지막 ACK가 유실될 경우, 서버는 FIN을 재전송한다. TIME_WAIT 상태가 없으면 클라이언트는 이미 연결을 종료했기 때문에 RST 패킷을 보내게 되고, 서버는 비정상적으로 종료될 수 있다. 
